<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªçc s·ªë üê≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: "IBM Plex Sans", sans-serif;
        }
        /* Custom styles for disabled inputs to match wireframe */
        input:disabled, input[readonly] {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #6b7280; /* text-gray-500 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm">
        
        <div id="screen1" class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
            <h1 class="text-2xl font-bold text-center text-gray-800">ƒê·ªçc s·ªë üê≠</h1>
            
            <div>
                <label for="numberPreview" class="block text-sm font-medium text-gray-700">number</label>
                <input type="text" id="numberPreview" readonly class="w-full p-3 border border-gray-300 rounded-lg opacity-50 transition-opacity duration-300">
            </div>

            <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-center transition-opacity duration-300 opacity-50 flex flex-col justify-center items-center h-24">
                <span id="hanziPreviewPinyin" class="text-sm text-gray-600 mb-1"></span>
                <span id="hanziPreviewHanzi" class="text-xl text-gray-900"></span>
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="showPinyin" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                <label for="showPinyin" class="ml-2 block text-sm text-gray-900">show pinyin</label>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="maxDigits" class="block text-sm font-medium text-gray-700">max digits</label>
                    <input type="number" id="maxDigits" value="3" min="1" max="10" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="turn" class="block text-sm font-medium text-gray-700">turn</label>
                    <input type="number" id="turn" value="10" min="1" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>

            <div>
                <label for="timerSetting" class="block text-sm font-medium text-gray-700">timer (s)</label>
                <input type="number" id="timerSetting" value="5" min="1" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>

            <button id="startButton" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300">
                START
            </button>
        </div>

        <div id="screen2" class="bg-white p-6 rounded-2xl shadow-lg space-y-4 hidden">
            <h1 class="text-2xl font-bold text-center text-gray-800">ƒê·ªçc s·ªë üê≠</h1>
            
            <div>
                <label for="numberDisplay" class="block text-sm font-medium text-gray-700">number</label>
                <input type="text" id="numberDisplay" readonly class="w-full p-3 border border-gray-300 rounded-lg text-5xl font-bold text-center text-gray-900">
            </div>

            <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-center flex flex-col justify-center items-center h-24">
                <span id="hanziDisplayPinyin" class="text-base text-gray-600 mb-1"></span>
                <span id="hanziDisplayHanzi" class="text-2xl text-gray-900"></span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="maxDigitsDisplay" class="block text-sm font-medium text-gray-700">max digits</label>
                    <input type="number" id="maxDigitsDisplay" readonly disabled class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="turnDisplay" class="block text-sm font-medium text-gray-700">turn</label>
                    <input type="number" id="turnDisplay" readonly class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>

            <div id="timerDisplay" class="w-full text-center p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 font-medium">
                timer : 5s
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="backButton" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300">
                    BACK
                </button>
                <button id="nextButton" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300">
                    NEXT
                </button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const screen1 = document.getElementById('screen1');
            const screen2 = document.getElementById('screen2');

            // Screen 1 Elements
            const numberPreview = document.getElementById('numberPreview');
            const hanziPreviewPinyin = document.getElementById('hanziPreviewPinyin');
            const hanziPreviewHanzi = document.getElementById('hanziPreviewHanzi');
            const showPinyinCheckbox = document.getElementById('showPinyin');
            const maxDigitsInput = document.getElementById('maxDigits');
            const turnsInput = document.getElementById('turn');
            const timerSettingInput = document.getElementById('timerSetting');
            const startButton = document.getElementById('startButton');
            const screen1HanziContainer = hanziPreviewHanzi.closest('div'); 

            // Screen 2 Elements
            const numberDisplay = document.getElementById('numberDisplay');
            const hanziDisplayPinyin = document.getElementById('hanziDisplayPinyin');
            const hanziDisplayHanzi = document.getElementById('hanziDisplayHanzi');
            const maxDigitsDisplay = document.getElementById('maxDigitsDisplay');
            const turnDisplay = document.getElementById('turnDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const backButton = document.getElementById('backButton');
            const nextButton = document.getElementById('nextButton');

            // --- Game State ---
            let gameInterval = null;
            let currentTurn = 1;
            let totalTurns = 10;
            let maxDigits = 3;
            let timerDuration = 5;
            let doShowPinyin = false;
            let currentNumber = 0;
            let currentChinese = {};
            let currentPreviewNum = 0; 
            let currentPreviewChinese = {}; 

            // --- Chinese Number Converter (up to 10 digits) ---

            // Helper function to convert a 4-digit number (0-9999)
            // This contains the "li«éng" and "yƒ´ sh√≠" logic.
            function convertFourDigit(num) {
                if (num === 0) return { hanzi: "Èõ∂", pinyin: "l√≠ng" };

                const digits = ["Èõ∂", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù"];
                const pinyinDigits = ["l√≠ng", "yƒ´", "√®r", "sƒÅn", "s√¨", "w«î", "li√π", "qƒ´", "bƒÅ", "ji«î"];
                const units = ["", "ÂçÅ", "Áôæ", "ÂçÉ"];
                const pinyinUnits = ["", "sh√≠", "b«éi", "qiƒÅn"];
                const liangHanzi = "‰∏§";
                const liangPinyin = "li«éng";
                
                let s = String(num);
                let len = s.length;
                let hanzi = "";
                let pinyin = "";
                let zeroFlag = false;

                for (let i = 0; i < len; i++) {
                    let digit = parseInt(s[i]);
                    let unitIndex = len - 1 - i;

                    if (digit === 0) {
                        zeroFlag = true;
                    } else {
                        if (zeroFlag) {
                            hanzi += digits[0];
                            pinyin += pinyinDigits[0] + " ";
                            zeroFlag = false;
                        }
                        
                        let currentHanziDigit = digits[digit];
                        let currentPinyinDigit = pinyinDigits[digit];

                        // FIX: Use "li«éng" for 2 in hundreds/thousands place
                        if (digit === 2 && (unitIndex === 2 || unitIndex === 3)) {
                            currentHanziDigit = liangHanzi;
                            currentPinyinDigit = liangPinyin;
                        }
                        
                        // FIX: Special case for '10-19' (ÂçÅ)
                        if (digit === 1 && unitIndex === 1 && len === 2) {
                             hanzi += units[unitIndex];
                             pinyin += pinyinUnits[unitIndex] + " ";
                        } else {
                            hanzi += currentHanziDigit + units[unitIndex];
                            pinyin += currentPinyinDigit + " " + (units[unitIndex] ? pinyinUnits[unitIndex] + " " : "");
                        }
                    }
                }
                return { hanzi, pinyin: pinyin.trim() };
            }

            // Main function to convert large numbers
            function convertToChinese(num) {
                if (num === 0) return { hanzi: "Èõ∂", pinyin: "l√≠ng" };
                
                // Use Number.MAX_SAFE_INTEGER as a practical cap if maxDigits is huge
                if (num > Number.MAX_SAFE_INTEGER) {
                    return { hanzi: "Êï∞Â≠óÂ§™Â§ß", pinyin: "sh√π z√¨ t√†i d√†" };
                }

                let s = String(num);
                const majorUnits = ["", "‰∏á", "‰∫ø"];
                const pinyinMajorUnits = ["", "w√†n", "y√¨"];
                
                let finalHanzi = "";
                let finalPinyin = "";
                let i = 0; // major unit index
                let lastChunkWasZero = false; // Flag for "Èõ∂" insertion

                while (s.length > 0) {
                    // Get chunk of 4 from the right
                    let chunkStr = s.substring(Math.max(0, s.length - 4));
                    s = s.substring(0, Math.max(0, s.length - 4));
                    let chunkNum = parseInt(chunkStr);

                    if (chunkNum === 0) {
                        // If chunk is "0000", we may need a "Èõ∂"
                        // Set flag only if we have processed non-zero chunks to our right
                        if (finalHanzi.length > 0) {
                            lastChunkWasZero = true;
                        }
                    } else {
                        // Process the non-zero chunk
                        let { hanzi: chunkHanzi, pinyin: chunkPinyin } = convertFourDigit(chunkNum);
                        
                        let unitHanzi = majorUnits[i];
                        let unitPinyin = pinyinMajorUnits[i] ? " " + pinyinMajorUnits[i] : "";
                        
                        let zeroHanzi = "";
                        let zeroPinyin = "";

                        // Add "Èõ∂" if:
                        // 1. The previous chunk was "0000" (e.g., 1,0000,0001 -> ‰∏Ä‰∫ø *Èõ∂* ‰∏Ä)
                        // 2. Or, this is not the right-most chunk AND this chunk is < 1000 
                        //    (e.g., 1,0001 -> "‰∏Ä‰∏á" + *Èõ∂* + "‰∏Ä")
                        if (lastChunkWasZero || (finalHanzi.length > 0 && chunkNum < 1000)) {
                            zeroHanzi = "Èõ∂";
                            zeroPinyin = "l√≠ng ";
                        }
                        
                        lastChunkWasZero = false; // Reset flag

                        // Prepend this chunk's result to the final string
                        finalHanzi = chunkHanzi + unitHanzi + zeroHanzi + finalHanzi;
                        finalPinyin = chunkPinyin + unitPinyin + (zeroPinyin ? " " + zeroPinyin : "") + finalPinyin;
                    }
                    i++; // Move to next major unit (‰∏á, ‰∫ø)
                }
                
                return { hanzi: finalHanzi, pinyin: finalPinyin.trim() };
            }


            // --- Game Logic Functions ---

            function startGame() {
                // 1. Get settings from Screen 1
                maxDigits = parseInt(maxDigitsInput.value) || 3;
                
                // UPDATED: Limit max digits to 10
                if (maxDigits > 10) {
                    maxDigits = 10;
                    maxDigitsInput.value = 10;
                }
                
                totalTurns = parseInt(turnsInput.value) || 10;
                timerDuration = parseInt(timerSettingInput.value) || 5;
                doShowPinyin = showPinyinCheckbox.checked;
                currentTurn = 1;

                // 2. Update Screen 2 UI
                maxDigitsDisplay.value = maxDigits;
                turnDisplay.value = totalTurns;
                
                // 3. Switch screens
                screen1.classList.add('hidden');
                screen2.classList.remove('hidden');

                // 4. Start first turn
                runNextTurn();
            }

            function stopGame() {
                clearInterval(gameInterval);
                screen2.classList.add('hidden');
                screen1.classList.remove('hidden');

                timerDisplay.classList.remove('bg-red-500', 'text-white', 'text-red-500', 'font-bold', 'text-xl');
                timerDisplay.classList.add('bg-gray-50', 'text-gray-700', 'font-medium');
                timerDisplay.innerText = `timer : ${timerDuration}s`;

                numberPreview.value = "";
                hanziPreviewPinyin.innerText = ""; 
                hanziPreviewHanzi.innerText = ""; 
                numberPreview.classList.add('opacity-50');
                screen1HanziContainer.classList.add('opacity-50');
                nextButton.innerText = "NEXT";
            }

            function runNextTurn() {
                if (currentTurn > totalTurns) {
                    stopGame();
                    return;
                }

                // 1. Reset fields
                hanziDisplayPinyin.innerText = "";
                hanziDisplayHanzi.innerText = "";
                nextButton.disabled = true;
                nextButton.classList.add('opacity-50', 'cursor-not-allowed');

                // 1.5 Update turn display
                turnDisplay.value = totalTurns - currentTurn + 1;

                // 1.6 Reset timer display styles
                timerDisplay.classList.remove('bg-red-500', 'text-white', 'text-red-500', 'font-bold', 'text-xl');
                timerDisplay.classList.add('bg-gray-50', 'text-gray-700', 'font-medium');

                // 2. Generate new number
                // Use BigInt for numbers > 15 digits, but for 10, Math.pow is fine.
                // Note: Max safe integer is ~9 quadrillion (16 digits).
                const maxNum = Math.pow(10, maxDigits);
                // Ensure we get large numbers. (maxNum - 1) is not safe for large maxDigits.
                // Let's generate a random string of digits instead.
                let numStr = "";
                for (let i = 0; i < maxDigits; i++) {
                    // First digit can't be 0 (unless maxDigits is 1)
                    if (i === 0 && maxDigits > 1) {
                         numStr += Math.floor(Math.random() * 9) + 1;
                    } else if (maxDigits === 1) {
                         numStr += Math.floor(Math.random() * 10); // 0-9
                    } else {
                        numStr += Math.floor(Math.random() * 10);
                    }
                }
                
                currentNumber = parseInt(numStr);
                // Handle 0 for 1-digit case
                if (maxDigits === 1 && currentNumber === 0) { 
                     // allow 0
                } else if (currentNumber === 0) {
                     currentNumber = 1; // fallback
                }
                
                numberDisplay.value = currentNumber;

                // 3. Convert to Chinese (but don't show yet)
                currentChinese = convertToChinese(currentNumber);

                // 4. Start timer
                startTimer();

                // 5. Update turn counter
                currentTurn++;
            }

            function startTimer() {
                clearInterval(gameInterval);
                let timeLeft = timerDuration;
                timerDisplay.innerText = `timer : ${timeLeft}s`;

                timerDisplay.classList.remove('bg-gray-50', 'text-gray-700', 'font-medium');
                timerDisplay.classList.add('text-red-500', 'font-bold', 'text-xl');

                gameInterval = setInterval(() => {
                    timeLeft--;

                    if (timeLeft <= 0) {
                        timerDisplay.innerText = "o((>œâ< ))o H·∫øt gi·ªù !!!";
                        clearInterval(gameInterval);

                        timerDisplay.classList.remove('text-red-500');
                        timerDisplay.classList.add('bg-gray-50', 'text-red-500'); 
                        
                        showResult();
                    } else {
                        timerDisplay.innerText = `timer : ${timeLeft}s`;
                    }
                }, 1000);
            }

            function showResult() {
                // Speak the number
                speakChinese(currentChinese.hanzi);
                
                hanziDisplayHanzi.innerText = currentChinese.hanzi;
                if (doShowPinyin) {
                    hanziDisplayPinyin.innerText = currentChinese.pinyin;
                } else {
                    hanziDisplayPinyin.innerText = "";
                }

                // Enable Next button
                nextButton.disabled = false;
                nextButton.classList.remove('opacity-50', 'cursor-not-allowed');

                // Check if last turn
                if (currentTurn > totalTurns) {
                    nextButton.innerText = "FINISH";
                }
            }

            // --- Text-to-Speech ---
            function speakChinese(text) {
                if ('speechSynthesis' in window) {
                    // Cancel any previous speech
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN'; 
                    utterance.rate = 0.9; 
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log("Speech synthesis not supported in this browser.");
                }
            }

            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            backButton.addEventListener('click', () => {
                 window.speechSynthesis.cancel(); // Stop speech on back
                 stopGame();
            });
            nextButton.addEventListener('click', () => {
                 window.speechSynthesis.cancel(); // Stop speech on next
                 runNextTurn();
            });

            // Update Screen 1 Pinyin Preview
            showPinyinCheckbox.addEventListener('change', () => {
                if (showPinyinCheckbox.checked) {
                    hanziPreviewPinyin.innerText = currentPreviewChinese.pinyin;
                } else {
                    hanziPreviewPinyin.innerText = "";
                }
                hanziPreviewHanzi.innerText = currentPreviewChinese.hanzi;
            });

            // --- UPDATED: Dynamic Preview Listener ---
            maxDigitsInput.addEventListener('input', () => {
                let newMax = parseInt(maxDigitsInput.value) || 1;
                // UPDATED: Check against 10
                if (newMax > 10) {
                    newMax = 10;
                    maxDigitsInput.value = 10; 
                }
                if (newMax < 1) {
                    newMax = 1;
                    maxDigitsInput.value = 1; 
                }

                // Generate new preview number (using the same string method as the game)
                let numStr = "";
                for (let i = 0; i < newMax; i++) {
                    if (i === 0 && newMax > 1) {
                         numStr += Math.floor(Math.random() * 9) + 1;
                    } else if (newMax === 1) {
                         numStr += Math.floor(Math.random() * 10);
                    } else {
                        numStr += Math.floor(Math.random() * 10);
                    }
                }
                const previewNum = parseInt(numStr) || 0;

                currentPreviewNum = previewNum;
                numberPreview.value = currentPreviewNum;
                
                currentPreviewChinese = convertToChinese(currentPreviewNum);
                
                if (showPinyinCheckbox.checked) {
                    hanziPreviewPinyin.innerText = currentPreviewChinese.pinyin;
                } else {
                    hanziPreviewPinyin.innerText = "";
                }
                hanziPreviewHanzi.innerText = currentPreviewChinese.hanzi;
            });


            // --- Initial UI setup ---
            function initializeScreen1Preview() {
                // Default preview to 3 digits
                const defaultMax = 3;
                const maxNum = Math.pow(10, defaultMax);
                const previewNum = Math.floor(Math.random() * (maxNum - 1)) + 1; 

                currentPreviewNum = previewNum; 
                numberPreview.value = currentPreviewNum;
                
                currentPreviewChinese = convertToChinese(currentPreviewNum);
                
                if (showPinyinCheckbox.checked) {
                    hanziPreviewPinyin.innerText = currentPreviewChinese.pinyin;
                }
                hanziPreviewHanzi.innerText = currentPreviewChinese.hanzi;

                // Make preview visible
                numberPreview.classList.remove('opacity-50');
                screen1HanziContainer.classList.remove('opacity-50');
            }
            initializeScreen1Preview(); // Call on load
        });
    </script>
</body>
</html>
